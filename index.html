<!--
Double Voice Explorer v2.0 (Internal Update)
Enhanced with Kappa Coefficient Validation

Author: Nozomi Sawada
GitHub: https://github.com/nozomi-sawada/double-voice-explorer
License: MIT

Description: Interactive visualization tool for "Double Voice" phenomena analysis
Technology: Pure HTML/CSS/JavaScript with Chart.js and Papa Parse
Validation: Cohen's weighted kappa coefficients (Sawada & Sasaki, DH 2025)
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Double Voice Explorer - 4-Category Analysis (LO/LWR √ó Editorial/Correspondence)</title>

    <!-- Local JavaScript libraries for offline support and security -->
    <script src="./chart.min.js"></script>
    <script src="./papaparse.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 10px;
        }

        .subtitle {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 30px;
        }

        .newspaper-selector {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .newspaper-card {
            background: white;
            padding: 15px 25px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            border: 3px solid transparent;
            min-width: 200px;
            text-align: center;
        }

        .newspaper-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .newspaper-card.active {
            border-color: #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
        }

        .newspaper-title {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .newspaper-years {
            color: #7f8c8d;
            font-size: 14px;
        }

        .newspaper-status {
            font-size: 12px;
            margin-top: 5px;
        }

        .loaded {
            color: #27ae60;
        }

        .not-loaded {
            color: #e74c3c;
        }

        .status-ok {
            color: #27ae60;
        }

        .controls {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .control-group {
            display: inline-block;
            margin-right: 30px;
            margin-bottom: 15px;
        }

        label {
            font-weight: 600;
            color: #495057;
            margin-right: 10px;
        }

        select, input {
            padding: 8px 12px;
            border: 2px solid #dee2e6;
            border-radius: 5px;
            font-size: 14px;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            position: relative;
            height: 400px;
        }

        .results {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            max-height: 500px;
            overflow-y: auto;
        }

        .result-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            border-left: 4px solid #667eea;
            position: relative;
        }

        .content-tag {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: bold;
            color: white;
        }

        .content-tag.lo-editorial {
            background: #e74c3c;
        }

        .content-tag.lo-correspondence {
            background: #f39c12;
        }

        .content-tag.lwr-editorial {
            background: #3498db;
        }

        .content-tag.lwr-correspondence {
            background: #27ae60;
        }

        .emotion-pair {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .score {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 12px;
            margin-right: 5px;
            position: relative;
            cursor: help;
        }

        .score:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 11px;
            white-space: pre-line;
            z-index: 1000;
            pointer-events: none;
            margin-bottom: 5px;
            min-width: 150px;
            text-align: left;
        }

        .score:hover::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: rgba(0, 0, 0, 0.9);
            margin-bottom: -7px;
            z-index: 1001;
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            position: relative;
            cursor: help;
        }

        .stat-card:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: pre-line;
            z-index: 1000;
            pointer-events: none;
            margin-bottom: 5px;
            min-width: 200px;
        }

        .stat-card:hover::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: rgba(0, 0, 0, 0.9);
            margin-bottom: -7px;
            z-index: 1001;
        }

        .stat-value {
            font-size: 28px;
            font-weight: bold;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.9;
            margin-top: 5px;
        }

        .data-upload {
            background: #e9ecef;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .upload-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .upload-section {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border: 2px dashed #dee2e6;
        }

        .upload-section h4 {
            margin-top: 0;
            color: #495057;
            font-size: 14px;
        }

        #dataStatus {
            margin-top: 10px;
        }

        .comparison-mode {
            background: #fff3cd;
            border: 1px solid #ffeeba;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }

        .comparison-mode.active {
            display: block;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #dee2e6;
        }

        .tab {
            padding: 10px 20px;
            background: none;
            border: none;
            color: #495057;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab:hover {
            color: #667eea;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #6c757d;
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 10px 0;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
        }

        .info-section {
            background: #e8f4f8;
            border-left: 4px solid #3498db;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }

        .info-toggle {
            background: #3498db;
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .info-toggle:hover {
            background: #2980b9;
        }

        .formula-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .formula-card {
            background: white;
            padding: 12px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }

        .formula-card h4 {
            margin: 0 0 8px 0;
            color: #2c3e50;
            font-size: 14px;
        }

        .formula-card .formula {
            background: #f8f9fa;
            padding: 8px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            margin: 5px 0;
        }

        .formula-card .description {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        /* Validation Information Styles */
        .validation-info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            display: none;
        }

        .validation-info h4 {
            margin: 0 0 10px 0;
            color: #495057;
            font-size: 16px;
        }

        .validation-info p {
            margin: 8px 0;
            font-size: 14px;
            line-height: 1.5;
        }

        .validation-info strong {
            color: #2c3e50;
        }

        .future-updates {
            background: #e7f3ff;
            border: 1px solid #bee5eb;
            border-radius: 6px;
            padding: 12px;
            margin-top: 12px;
            font-size: 13px;
            color: #0c5460;
        }

        .future-updates h5 {
            margin: 0 0 8px 0;
            color: #0c5460;
            font-size: 14px;
        }

        /* Reliability Warning Styles */
        .reliability-warning {
            padding: 10px 15px;
            border-radius: 6px;
            margin: 10px 0;
            font-size: 14px;
            font-weight: 500;
            display: none;
        }

        .reliability-warning.high {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .reliability-warning.moderate {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .reliability-warning.asymmetric {
            background: #ffeaa7;
            color: #856404;
            border: 1px solid #f39c12;
        }

        .reliability-warning.caution {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé≠ Double Voice Explorer
            <span class="analysis-mode-badge" id="modeBadge" style="display: none;">4-Category Analysis Mode</span>
        </h1>
        <p class="subtitle">Colonial Lagos Newspapers: 4-Category Emotional Analysis (Editorial & Correspondence by Newspaper)</p>

        <div class="newspaper-selector">
            <div class="newspaper-card" id="lo-card" data-newspaper="LO">
                <div class="newspaper-title">Lagos Observer</div>
                <div class="newspaper-years">1882-1888</div>
                <div class="newspaper-status not-loaded" id="lo-status">No data loaded</div>
            </div>

            <div class="newspaper-card" id="lwr-card" data-newspaper="LWR">
                <div class="newspaper-title">Lagos Weekly Record</div>
                <div class="newspaper-years">1891-1921</div>
                <div class="newspaper-status not-loaded" id="lwr-status">No data loaded</div>
            </div>

            <div class="newspaper-card" id="editorial-reader-card" data-newspaper="FOUR_CATEGORY">
                <div class="newspaper-title">4-Category Analysis</div>
                <div class="newspaper-years">Complete Comparison</div>
                <div class="newspaper-status" id="editorial-reader-status">Load all data for analysis</div>
            </div>
        </div>

        <div class="data-upload">
            <h3>üìÅ Upload Data Files</h3>
            <div class="upload-grid">
                <div class="upload-section">
                    <h4>üì∞ Lagos Observer - Editorials</h4>
                    <input type="file" id="loFileInput" accept=".csv,.txt">
                    <div id="loDataStatus"></div>
                </div>

                <div class="upload-section">
                    <h4>‚úâÔ∏è Lagos Observer - Correspondence</h4>
                    <input type="file" id="loSubmissionsFileInput" accept=".csv,.txt">
                    <div id="loSubmissionsDataStatus"></div>
                    <small style="color: #6c757d;">Reader submissions section</small>
                </div>

                <div class="upload-section">
                    <h4>üì∞ Lagos Weekly Record - Editorials</h4>
                    <input type="file" id="lwrFileInput" accept=".csv,.txt">
                    <div id="lwrDataStatus"></div>
                </div>

                <div class="upload-section" style="opacity: 0.5;">
                    <h4>‚úâÔ∏è LWR Reader Submissions</h4>
                    <input type="file" id="lwrSubmissionsFileInput" accept=".csv,.txt" disabled>
                    <div id="lwrSubmissionsDataStatus"></div>
                    <small style="color: #e74c3c;">Future expansion - Currently not available</small>
                </div>
            </div>
        </div>

        <div class="comparison-mode" id="comparisonMode">
            <strong>üìä 4-Category Analysis Mode Active</strong>
            <p>Comparing emotional patterns across: LO Editorial, LO Correspondence, LWR Editorial, and LWR Correspondence</p>
        </div>

        <div class="controls">
            <div class="control-group">
                <label>Emotion Pair:</label>
                <select id="emotionPair">
                    <option value="Trust_Disgust">Trust ‚Üî Disgust (Œ∫=0.705, 0.843) ‚≠ê Primary Choice</option>
                    <option value="Joy_Sadness">Joy ‚Üî Sadness (Œ∫=0.747, 0.321) ‚ö†Ô∏è Asymmetric Reliability</option>
                    <option value="Anger_Fear">Anger ‚Üî Fear (Œ∫=0.819, 0.300) ‚ö†Ô∏è Asymmetric Reliability</option>
                    <option value="Anticipation_Surprise">Anticipation ‚Üî Surprise (Œ∫=0.419, 0.441) ‚ö†Ô∏è Moderate Reliability</option>
                </select>
                <div id="reliabilityWarning" style="margin-top: 5px; font-size: 12px; color: #666;"></div>
            </div>

            <div class="control-group">
                <label>Threshold:</label>
                <input type="range" id="threshold" min="0" max="1" step="0.05" value="0.5">
                <span id="thresholdValue">0.5</span>
            </div>

            <div class="control-group">
                <label>Year Range:</label>
                <input type="number" id="yearFrom" min="1882" max="1921" value="1882" style="width: 80px;">
                <span> - </span>
                <input type="number" id="yearTo" min="1882" max="1921" value="1921" style="width: 80px;">
            </div>

            <div class="control-group">
                <label>Content Type:</label>
                <select id="contentTypeFilter">
                    <option value="ALL">All Types</option>
                    <option value="Editorial">Editorials Only</option>
                    <option value="Submission">Correspondence Only</option>
                </select>
            </div>

            <div class="control-group">
                <label>Newspaper:</label>
                <select id="newspaperFilter">
                    <option value="ALL">All Newspapers</option>
                    <option value="LO">Lagos Observer Only</option>
                    <option value="LWR">Lagos Weekly Record Only</option>
                </select>
            </div>

            <button id="updateAnalysisBtn">Update Analysis</button>
            <button id="exportBtn" title="Export analysis results to CSV">Export Results</button>
            <button id="compareBtn" disabled>Launch 4-Category Comparison</button>
            <button class="info-toggle" id="toggleFormulasBtn" style="float: right;">üìä Show Formulas</button>
            <button class="info-toggle" id="toggleValidationBtn" style="float: right; margin-right: 10px;">üî¨ Show Validation</button>
        </div>

        <div class="info-section" id="formulaSection" style="display: none;">
            <h3 style="margin-top: 0; color: #2c3e50;">Double Voice Calculation Methods</h3>
            <div class="formula-grid">
                <div class="formula-card">
                    <h4>üéØ DV Score (Geometric Mean)</h4>
                    <div class="formula">‚àö(Emotion1 √ó Emotion2)</div>
                    <div class="description">Measures the synergistic strength of both emotions</div>
                </div>
                <div class="formula-card">
                    <h4>üìâ DV Min (Minimum)</h4>
                    <div class="formula">min(Emotion1, Emotion2)</div>
                    <div class="description">The weaker emotion acts as bottleneck</div>
                </div>
                <div class="formula-card">
                    <h4>‚öñÔ∏è Balance</h4>
                    <div class="formula">1 - |Emotion1 - Emotion2|</div>
                    <div class="description">How balanced the emotions are (1 = perfectly balanced)</div>
                </div>
                <div class="formula-card">
                    <h4>üí™ Intensity</h4>
                    <div class="formula">(Emotion1 + Emotion2) / 2</div>
                    <div class="description">Average strength of both emotions</div>
                </div>
                <div class="formula-card">
                    <h4>‚úÖ Valid DV</h4>
                    <div class="formula">Both ‚â• Threshold ‚Üí 1, else ‚Üí 0</div>
                    <div class="description">True Double Voice requires both emotions above threshold</div>
                </div>
            </div>
        </div>

        <div class="validation-info" id="validationInfo" style="display: none;">
            <h4>üî¨ Validation Information</h4>
            <p><strong>Method:</strong> Cohen's weighted kappa coefficients with quadratic weighting</p>
            <p><strong>Dataset:</strong> Lagos Observer editorials (n=50)</p>
            <p><strong>Source:</strong> Sawada & Sasaki (2025). "Quantitative Analysis of Negativity in Colonial Nigerian Newspapers." <em>DH 2025</em>, Lisbon.</p>

            <h5>Reliability by Emotion:</h5>
            <ul>
                <li><strong>High (Œ∫ > 0.7):</strong> Disgust (0.843), Anger (0.819), Joy (0.747), Trust (0.705)</li>
                <li><strong>Moderate (Œ∫ ‚âà 0.4):</strong> Surprise (0.441), Anticipation (0.419)</li>
                <li><strong>Low (Œ∫ ‚âà 0.3):</strong> Sadness (0.321), Fear (0.300)</li>
            </ul>

            <div class="future-updates">
                <h5>üîÆ Future Development</h5>
                <p>Current validation limited to Lagos Observer subset. Future improvements planned:</p>
                <ul>
                    <li>Expanded validation with Lagos Weekly Record</li>
                    <li>Larger sample sizes for comprehensive statistical analysis</li>
                    <li>Additional visualization options and statistical measures</li>
                </ul>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" data-tab="overview">Overview</button>
            <button class="tab" data-tab="temporal" style="opacity: 0.5; cursor: not-allowed;" disabled>Temporal Analysis (Coming Soon)</button>
            <button class="tab" data-tab="comparison">4-Category Comparison</button>
        </div>

        <div class="stats-container" id="statsContainer">
            <div class="stat-card">
                <div class="stat-value">-</div>
                <div class="stat-label">Total Articles</div>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);">
                <div class="stat-value">-</div>
                <div class="stat-label">Editorials</div>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #27ae60 0%, #229954 100%);">
                <div class="stat-value">-</div>
                <div class="stat-label">Correspondence</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">-</div>
                <div class="stat-label">Valid DV</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">-</div>
                <div class="stat-label">DV %</div>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);">
                <div class="stat-value">-</div>
                <div class="stat-label">Editorial DV %</div>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);">
                <div class="stat-value">-</div>
                <div class="stat-label">Correspondence DV %</div>
            </div>
        </div>

        <div id="overview-content" class="tab-content">
            <div class="grid">
                <div class="chart-container">
                    <canvas id="scatterChart"></canvas>
                </div>

                <div class="chart-container">
                    <canvas id="timeChart"></canvas>
                </div>
            </div>
        </div>

        <div id="temporal-content" class="tab-content" style="display: none;">
            <div style="text-align: center; padding: 100px 20px;">
                <h2 style="color: #7f8c8d; margin-bottom: 20px;">üöß Coming Soon</h2>
                <p style="color: #95a5a6; font-size: 16px;">
                    Advanced temporal analysis features are under development.<br>
                    Please use the Overview tab for time series analysis.
                </p>
            </div>
        </div>

        <div id="comparison-content" class="tab-content" style="display: none;">
            <div class="grid">
                <div class="chart-container">
                    <canvas id="comparisonChart"></canvas>
                </div>

                <div class="chart-container">
                    <canvas id="distributionChart"></canvas>
                </div>
            </div>
        </div>

        <div class="results" id="results">
            <h3>Top Double Voice Instances</h3>
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: #e74c3c;"></div>
                    <span>LO Editorial</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #f39c12;"></div>
                    <span>LO Correspondence</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #3498db;"></div>
                    <span>LWR Editorial</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #27ae60;"></div>
                    <span>LWR Correspondence</span>
                </div>
            </div>
            <div id="resultsList" class="loading">Please upload data files to begin analysis</div>
        </div>
    </div>

    <script>
        // Global data storage
        let loEditorialData = [];
        let loSubmissionsData = [];
        let lwrEditorialData = [];
        let lwrSubmissionsData = [];
        let allData = [];
        let currentMode = null;
        let currentTab = 'overview';

        // Chart instances
        let scatterChart = null;
        let timeChart = null;
        let heatmapChart = null;
        let periodChart = null;
        let comparisonChart = null;
        let distributionChart = null;

        // CSV Formula Injection Protection
        function sanitizeForCSV(v) {
            const s = v == null ? '' : String(v);
            // Prefix with single quote if starts with = + - @ or tab/newline
            return /^[=+\-@\t\r\n]/.test(s) ? `'${s}` : s;
        }

        // Local date formatting
        function localDateStamp(d = new Date()) {
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${y}-${m}-${day}`;
        }

        function handleFileUpload(event, type) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }
            const reader = new FileReader();
            reader.onload = function(e) {
                parseData(e.target.result, type);
            };
            reader.onerror = function(e) {
                console.error('Error reading file:', e);
                alert('Error reading file: ' + file.name);
            };
            reader.readAsText(file);
        }

        function parseData(csvText, type) {
            Papa.parse(csvText, {
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                complete: function(results) {
                    let data = results.data;

                    // Clean column names and add metadata
                    data = data.map(row => {
                        const cleanRow = {};
                        Object.keys(row).forEach(key => {
                            const cleanKey = key.trim().replace(/\s+/g, '');
                            cleanRow[cleanKey] = row[key];
                        });

                        // Add metadata based on type
                        if (type === 'LO_Editorial') {
                            cleanRow.newspaper = 'LO';
                            cleanRow.contentType = 'Editorial';
                        } else if (type === 'LO_Submission') {
                            cleanRow.newspaper = 'LO';
                            cleanRow.contentType = 'Submission';
                        } else if (type === 'LWR_Editorial') {
                            cleanRow.newspaper = 'LWR';
                            cleanRow.contentType = 'Editorial';
                        } else if (type === 'LWR_Submission') {
                            cleanRow.newspaper = 'LWR';
                            cleanRow.contentType = 'Submission';
                        }

                        return cleanRow;
                    });

                    // Store data
                    if (type === 'LO_Editorial') {
                        loEditorialData = data;
                        const statusEl = document.getElementById('lo-status');
                        statusEl.className = 'newspaper-status loaded';
                        statusEl.textContent = `‚úì ${data.length} editorials`;
                        const statusDiv = document.getElementById('loDataStatus');
                        statusDiv.textContent = `‚úì ${data.length} editorials`;
                        statusDiv.className = 'status-ok';
                    } else if (type === 'LO_Submission') {
                        loSubmissionsData = data;
                        const statusDiv = document.getElementById('loSubmissionsDataStatus');
                        statusDiv.textContent = `‚úì ${data.length} correspondence`;
                        statusDiv.className = 'status-ok';
                        updateSubmissionStatus();
                    } else if (type === 'LWR_Editorial') {
                        lwrEditorialData = data;
                        const statusEl = document.getElementById('lwr-status');
                        statusEl.className = 'newspaper-status loaded';
                        statusEl.textContent = `‚úì ${data.length} editorials`;
                        const statusDiv = document.getElementById('lwrDataStatus');
                        statusDiv.textContent = `‚úì ${data.length} editorials`;
                        statusDiv.className = 'status-ok';
                    } else if (type === 'LWR_Submission') {
                        lwrSubmissionsData = data;
                        const statusDiv = document.getElementById('lwrSubmissionsDataStatus');
                        statusDiv.textContent = `‚úì ${data.length} submissions`;
                        statusDiv.className = 'status-ok';
                        updateSubmissionStatus();
                    }

                    // Combine all data
                    allData = [...loEditorialData, ...loSubmissionsData, ...lwrEditorialData, ...lwrSubmissionsData];

                    // Update year range
                    if (allData.length > 0) {
                        const years = [...new Set(allData.map(d => d.year || d.Year))].filter(y => y).sort();
                        if (years.length > 0) {
                            document.getElementById('yearFrom').min = years[0];
                            document.getElementById('yearFrom').max = years[years.length - 1];
                            document.getElementById('yearTo').min = years[0];
                            document.getElementById('yearTo').max = years[years.length - 1];
                        }
                    }

                    // Enable comparison if we have submission data
                    updateComparisonButton();
                }
            });
        }

        function updateSubmissionStatus() {
            const hasSubmissions = loSubmissionsData.length > 0 || lwrSubmissionsData.length > 0;
            if (hasSubmissions) {
                const statusEl = document.getElementById('editorial-reader-status');
                statusEl.className = 'newspaper-status loaded';
                statusEl.textContent = '‚úì Ready for analysis';
            }
        }

        function updateComparisonButton() {
            const hasEditorials = loEditorialData.length > 0 || lwrEditorialData.length > 0;
            const hasSubmissions = loSubmissionsData.length > 0 || lwrSubmissionsData.length > 0;
            document.getElementById('compareBtn').disabled = !(hasEditorials && hasSubmissions);
        }

        function selectNewspaper(mode) {
            currentMode = mode;

            // Update UI
            document.querySelectorAll('.newspaper-card').forEach(card => {
                card.classList.remove('active');
            });

            document.getElementById('comparisonMode').classList.remove('active');
            document.getElementById('modeBadge').style.display = 'none';

            if (mode === 'LO') {
                document.getElementById('lo-card').classList.add('active');
                document.getElementById('newspaperFilter').value = 'LO';
                document.getElementById('contentTypeFilter').value = 'ALL';
            } else if (mode === 'LWR') {
                document.getElementById('lwr-card').classList.add('active');
                document.getElementById('newspaperFilter').value = 'LWR';
                document.getElementById('contentTypeFilter').value = 'ALL';
            } else if (mode === 'FOUR_CATEGORY') {
                document.getElementById('editorial-reader-card').classList.add('active');
                document.getElementById('comparisonMode').classList.add('active');
                document.getElementById('modeBadge').style.display = 'inline-block';
                document.getElementById('modeBadge').textContent = '4-Category Analysis Mode';
                document.getElementById('newspaperFilter').value = 'ALL';
                switchTab(null, 'comparison');
            }

            updateAnalysis();
        }

        function switchTab(event, tab) {
            // Temporal tab is disabled
            if (tab === 'temporal') {
                return;
            }

            currentTab = tab;

            // Update tab buttons
            document.querySelectorAll('.tab:not([disabled])').forEach(t => t.classList.remove('active'));

            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // Find the tab button by its text content
                document.querySelectorAll('.tab:not([disabled])').forEach(t => {
                    if (tab === 'overview' && t.textContent.includes('Overview')) {
                        t.classList.add('active');
                    } else if (tab === 'comparison' && t.textContent.includes('4-Category')) {
                        t.classList.add('active');
                    }
                });
            }

            // Hide all content
            document.getElementById('overview-content').style.display = 'none';
            document.getElementById('temporal-content').style.display = 'none';
            document.getElementById('comparison-content').style.display = 'none';

            // Show selected content
            const selectedContent = document.getElementById(`${tab}-content`);
            if (selectedContent) {
                selectedContent.style.display = 'block';
            }

            // Update charts if needed
            if (tab === 'comparison' && allData.length > 0) {
                updateComparisonCharts();
            }
        }

        function calculateDoubleVoice(record, emotion1, emotion2, threshold) {
            // Robustness: Explicitly convert to number and handle NaN
            const val1 = parseFloat(record[emotion1]) || 0;
            const val2 = parseFloat(record[emotion2]) || 0;

            const isDoubleVoice = val1 >= threshold && val2 >= threshold;

            if (!isDoubleVoice) {
                return {
                    geometric: 0,
                    minimum: 0,
                    harmonic: 0,
                    balance: 0,
                    intensity: 0,
                    isValid: false
                };
            }

            return {
                geometric: Math.sqrt(val1 * val2),
                minimum: Math.min(val1, val2),
                harmonic: val1 && val2 ? 2 * val1 * val2 / (val1 + val2) : 0,
                balance: 1 - Math.abs(val1 - val2),
                intensity: (val1 + val2) / 2,
                isValid: true
            };
        }

        function updateAnalysis() {
            const pair = document.getElementById('emotionPair').value;
            const thresholdInput = document.getElementById('threshold');
            const yearFromInput = document.getElementById('yearFrom');
            const yearToInput = document.getElementById('yearTo');

            // Robustness: Handle NaN cases with fallback to default values
            const threshold = parseFloat(thresholdInput.value) || 0.5;
            const yearFromRaw = parseInt(yearFromInput.value, 10);
            const yearToRaw = parseInt(yearToInput.value, 10);
            const yearFrom = isNaN(yearFromRaw) ? (parseInt(yearFromInput.min, 10) || 1882) : yearFromRaw;
            const yearTo = isNaN(yearToRaw) ? (parseInt(yearToInput.max, 10) || 1921) : yearToRaw;

            const contentTypeFilter = document.getElementById('contentTypeFilter').value;
            const newspaperFilter = document.getElementById('newspaperFilter').value;

            // Filter data
            let filteredData = allData;

            // Content Type filter
            if (contentTypeFilter !== 'ALL') {
                filteredData = filteredData.filter(d => d.contentType === contentTypeFilter);
            }

            // Newspaper filter
            if (newspaperFilter !== 'ALL') {
                filteredData = filteredData.filter(d => d.newspaper === newspaperFilter);
            }

            if (filteredData.length === 0) {
                const listElement = document.getElementById('resultsList');
                listElement.textContent = 'No data available. Please upload data files.';
                return;
            }

            // Filter by year
            filteredData = filteredData.filter(d => {
                const year = d.year || d.Year;
                return year >= yearFrom && year <= yearTo;
            });

            const [emotion1, emotion2] = pair.split('_');

            // Calculate double voice scores
            const scores = filteredData.map(record => {
                const dvScores = calculateDoubleVoice(record, emotion1, emotion2, threshold);
                return {
                    ...record,
                    doubleVoice: dvScores.geometric,
                    doubleVoiceMin: dvScores.minimum,
                    balance: dvScores.balance,
                    intensity: dvScores.intensity,
                    isValid: dvScores.isValid
                };
            });

            // Update visualizations
            updateStats(scores, emotion1, emotion2, threshold);
            updateScatterPlot(scores, emotion1, emotion2, threshold);
            updateTimeSeries(scores, emotion1, emotion2);
            updateResultsList(scores, emotion1, emotion2);

            if (currentTab === 'comparison') {
                updateComparisonCharts();
            }
        }

        function updateStats(scores, emotion1, emotion2, threshold) {
            const validDV = scores.filter(s => s.isValid);

            // 4 categories breakdown
            const loEditorials = scores.filter(s => s.newspaper === 'LO' && s.contentType === 'Editorial');
            const loCorrespondence = scores.filter(s => s.newspaper === 'LO' && s.contentType === 'Submission');
            const lwrEditorials = scores.filter(s => s.newspaper === 'LWR' && s.contentType === 'Editorial');
            const lwrCorrespondence = scores.filter(s => s.newspaper === 'LWR' && s.contentType === 'Submission');

            const validLOE = loEditorials.filter(s => s.isValid);
            const validLOC = loCorrespondence.filter(s => s.isValid);
            const validLWRE = lwrEditorials.filter(s => s.isValid);
            const validLWRC = lwrCorrespondence.filter(s => s.isValid);

            const dvPercentage = scores.length > 0 ?
                ((validDV.length / scores.length) * 100).toFixed(1) : 0;
            const loeDVPercentage = loEditorials.length > 0 ?
                ((validLOE.length / loEditorials.length) * 100).toFixed(1) : 0;
            const locDVPercentage = loCorrespondence.length > 0 ?
                ((validLOC.length / loCorrespondence.length) * 100).toFixed(1) : 0;
            const lwreDVPercentage = lwrEditorials.length > 0 ?
                ((validLWRE.length / lwrEditorials.length) * 100).toFixed(1) : 0;
            const lwrcDVPercentage = lwrCorrespondence.length > 0 ?
                ((validLWRC.length / lwrCorrespondence.length) * 100).toFixed(1) : 0;

            // Build stat cards using DOM methods
            const container = document.getElementById('statsContainer');
            container.textContent = ''; // Clear existing content

            const statsData = [
                {
                    value: scores.length,
                    label: 'Total Articles',
                    tooltip: 'Total number of articles\nacross all categories',
                    gradient: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'
                },
                {
                    value: loEditorials.length,
                    label: `LO Editorial\n(${validLOE.length} DV, ${loeDVPercentage}%)`,
                    tooltip: `Lagos Observer Editorial articles\nDouble Voice rate: ${loeDVPercentage}%`,
                    gradient: 'linear-gradient(135deg, #e74c3c 0%, #c0392b 100%)'
                },
                {
                    value: loCorrespondence.length,
                    label: `LO Correspondence\n(${validLOC.length} DV, ${locDVPercentage}%)`,
                    tooltip: `Lagos Observer Correspondence\nDouble Voice rate: ${locDVPercentage}%`,
                    gradient: 'linear-gradient(135deg, #f39c12 0%, #e67e22 100%)'
                },
                {
                    value: lwrEditorials.length,
                    label: `LWR Editorial\n(${validLWRE.length} DV, ${lwreDVPercentage}%)`,
                    tooltip: `Lagos Weekly Record Editorial articles\nDouble Voice rate: ${lwreDVPercentage}%`,
                    gradient: 'linear-gradient(135deg, #3498db 0%, #2980b9 100%)'
                },
                {
                    value: lwrCorrespondence.length,
                    label: `LWR Correspondence\n(${validLWRC.length} DV, ${lwrcDVPercentage}%)`,
                    tooltip: `Lagos Weekly Record Correspondence\nDouble Voice rate: ${lwrcDVPercentage}%`,
                    gradient: 'linear-gradient(135deg, #27ae60 0%, #229954 100%)'
                },
                {
                    value: validDV.length,
                    label: `Total Valid DV\n(${dvPercentage}%)`,
                    tooltip: 'Articles where both emotions\nexceed the threshold',
                    gradient: 'linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%)'
                },
                {
                    value: threshold,
                    label: `Threshold\n(both ‚â• ${threshold})`,
                    tooltip: 'Minimum value required for\nboth emotions to count as\nDouble Voice',
                    gradient: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'
                }
            ];

            statsData.forEach(stat => {
                const card = document.createElement('div');
                card.className = 'stat-card';
                card.style.background = stat.gradient;
                card.setAttribute('data-tooltip', stat.tooltip);

                const valueDiv = document.createElement('div');
                valueDiv.className = 'stat-value';
                valueDiv.textContent = stat.value;

                const labelDiv = document.createElement('div');
                labelDiv.className = 'stat-label';
                labelDiv.textContent = stat.label;

                card.appendChild(valueDiv);
                card.appendChild(labelDiv);
                container.appendChild(card);
            });
        }

        function updateScatterPlot(scores, emotion1, emotion2, threshold) {
            const ctx = document.getElementById('scatterChart').getContext('2d');

            // Separate data by newspaper AND content type (4 categories)
            const loEditorials = scores.filter(s => s.newspaper === 'LO' && s.contentType === 'Editorial');
            const loCorrespondence = scores.filter(s => s.newspaper === 'LO' && s.contentType === 'Submission');
            const lwrEditorials = scores.filter(s => s.newspaper === 'LWR' && s.contentType === 'Editorial');
            const lwrCorrespondence = scores.filter(s => s.newspaper === 'LWR' && s.contentType === 'Submission');

            const datasets = [];

            if (loEditorials.length > 0) {
                datasets.push({
                    label: 'LO Editorial',
                    data: loEditorials.map(s => ({
                        x: s[emotion1] || 0,
                        y: s[emotion2] || 0,
                        id: s.id,
                        year: s.year || s.Year,
                        type: 'LO Editorial'
                    })),
                    backgroundColor: loEditorials.map(s =>
                        s.isValid ? 'rgba(231, 76, 60, 0.6)' : 'rgba(231, 76, 60, 0.2)'
                    ),
                    pointRadius: loEditorials.map(s => s.isValid ? 7 : 4)
                });
            }

            if (loCorrespondence.length > 0) {
                datasets.push({
                    label: 'LO Correspondence',
                    data: loCorrespondence.map(s => ({
                        x: s[emotion1] || 0,
                        y: s[emotion2] || 0,
                        id: s.id,
                        year: s.year || s.Year,
                        type: 'LO Correspondence'
                    })),
                    backgroundColor: loCorrespondence.map(s =>
                        s.isValid ? 'rgba(243, 156, 18, 0.6)' : 'rgba(243, 156, 18, 0.2)'
                    ),
                    pointRadius: loCorrespondence.map(s => s.isValid ? 7 : 4)
                });
            }

            if (lwrEditorials.length > 0) {
                datasets.push({
                    label: 'LWR Editorial',
                    data: lwrEditorials.map(s => ({
                        x: s[emotion1] || 0,
                        y: s[emotion2] || 0,
                        id: s.id,
                        year: s.year || s.Year,
                        type: 'LWR Editorial'
                    })),
                    backgroundColor: lwrEditorials.map(s =>
                        s.isValid ? 'rgba(52, 152, 219, 0.6)' : 'rgba(52, 152, 219, 0.2)'
                    ),
                    pointRadius: lwrEditorials.map(s => s.isValid ? 7 : 4)
                });
            }

            if (lwrCorrespondence.length > 0) {
                datasets.push({
                    label: 'LWR Correspondence',
                    data: lwrCorrespondence.map(s => ({
                        x: s[emotion1] || 0,
                        y: s[emotion2] || 0,
                        id: s.id,
                        year: s.year || s.Year,
                        type: 'LWR Correspondence'
                    })),
                    backgroundColor: lwrCorrespondence.map(s =>
                        s.isValid ? 'rgba(46, 204, 113, 0.6)' : 'rgba(46, 204, 113, 0.2)'
                    ),
                    pointRadius: lwrCorrespondence.map(s => s.isValid ? 7 : 4)
                });
            }

            const newTitle = `${emotion1} vs ${emotion2} Distribution`;

            // Performance: Use chart.update() instead of destroy + recreate
            if (scatterChart) {
                // Update existing chart
                scatterChart.data.datasets = datasets;
                scatterChart.options.plugins.title.text = newTitle;
                scatterChart.options.scales.x.title.text = emotion1;
                scatterChart.options.scales.y.title.text = emotion2;
                scatterChart.update();
            } else {
                // Create chart for the first time
                scatterChart = new Chart(ctx, {
                    type: 'scatter',
                    data: { datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: newTitle
                            },
                            legend: {
                                display: true
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const point = context.raw;
                                        return [
                                            `${point.type} #${point.id}`,
                                            `Year: ${point.year}`,
                                            `${emotion1}: ${point.x.toFixed(3)}`,
                                            `${emotion2}: ${point.y.toFixed(3)}`
                                        ];
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: emotion1
                                },
                                min: 0,
                                max: 1
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: emotion2
                                },
                                min: 0,
                                max: 1
                            }
                        }
                    }
                });
            }
        }

        function updateTimeSeries(scores, emotion1, emotion2) {
            const ctx = document.getElementById('timeChart').getContext('2d');

            // Group by year and full category (newspaper + content type)
            const yearlyData = {};
            scores.forEach(s => {
                const year = s.year || s.Year;
                const category = `${s.newspaper}_${s.contentType}`;
                const key = `${year}_${category}`;
                if (!yearlyData[key]) {
                    yearlyData[key] = {
                        year: year,
                        category: category,
                        scores: [],
                        validCount: 0
                    };
                }
                yearlyData[key].scores.push(s.doubleVoice);
                if (s.isValid) yearlyData[key].validCount++;
            });

            // Prepare datasets for 4 categories
            const categories = {
                'LO_Editorial': { years: [], scores: [], label: 'LO Editorial', color: 'rgba(231, 76, 60, 1)', bgColor: 'rgba(231, 76, 60, 0.1)' },
                'LO_Submission': { years: [], scores: [], label: 'LO Correspondence', color: 'rgba(243, 156, 18, 1)', bgColor: 'rgba(243, 156, 18, 0.1)' },
                'LWR_Editorial': { years: [], scores: [], label: 'LWR Editorial', color: 'rgba(52, 152, 219, 1)', bgColor: 'rgba(52, 152, 219, 0.1)' },
                'LWR_Submission': { years: [], scores: [], label: 'LWR Correspondence', color: 'rgba(46, 204, 113, 1)', bgColor: 'rgba(46, 204, 113, 0.1)' }
            };

            Object.values(yearlyData).forEach(data => {
                const avgScore = data.scores.reduce((sum, val) => sum + val, 0) / data.scores.length;
                if (categories[data.category]) {
                    categories[data.category].years.push(data.year);
                    categories[data.category].scores.push(avgScore);
                }
            });

            const datasets = [];

            Object.values(categories).forEach(cat => {
                if (cat.years.length > 0) {
                    const sorted = cat.years.map((year, i) => ({year, score: cat.scores[i]}))
                        .sort((a, b) => a.year - b.year);

                    datasets.push({
                        label: cat.label,
                        data: sorted.map(d => ({x: d.year, y: d.score})),
                        borderColor: cat.color,
                        backgroundColor: cat.bgColor,
                        tension: 0.4
                    });
                }
            });

            const newTitle = 'Double Voice Trends Over Time';

            // Performance: Use chart.update() instead of destroy + recreate
            if (timeChart) {
                // Update existing chart
                timeChart.data.datasets = datasets;
                timeChart.options.plugins.title.text = newTitle;
                timeChart.update();
            } else {
                // Create chart for the first time
                timeChart = new Chart(ctx, {
                    type: 'line',
                    data: { datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: newTitle
                            },
                            annotation: {
                                annotations: {
                                    gap: {
                                        type: 'box',
                                        xMin: 1888.5,
                                        xMax: 1890.5,
                                        backgroundColor: 'rgba(255, 243, 205, 0.3)',
                                        borderColor: 'rgba(255, 193, 7, 0.5)',
                                        borderWidth: 1,
                                        label: {
                                            content: 'Newspaper Gap',
                                            display: true,
                                            position: 'center'
                                        }
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                type: 'linear',
                                title: {
                                    display: true,
                                    text: 'Year'
                                },
                                ticks: {
                                    callback: function(value) {
                                        return Math.round(value).toString();
                                    }
                                }
                            },
                            y: {
                                beginAtZero: true,
                                max: 1,
                                title: {
                                    display: true,
                                    text: 'Average Double Voice Score'
                                }
                            }
                        }
                    }
                });
            }
        }

        function updateResultsList(scores, emotion1, emotion2) {
            const listElement = document.getElementById('resultsList');
            listElement.textContent = ''; // Clear with textContent

            const topScores = scores
                .filter(s => s.isValid)
                .sort((a, b) => Number(b.doubleVoice ?? 0) - Number(a.doubleVoice ?? 0))
                .slice(0, 100);

            if (topScores.length === 0) {
                const p1 = document.createElement('p');
                p1.textContent = 'No valid Double Voice data detected for the selected emotions.';
                const p2 = document.createElement('p');
                p2.textContent = 'Both emotions must be above the threshold to be valid.';
                listElement.append(p1, p2);
                return;
            }

            const fragment = document.createDocumentFragment();
            topScores.forEach((s, index) => {
                fragment.appendChild(createResultItem(s, index, emotion1, emotion2));
            });
            listElement.appendChild(fragment);
        }

        function createResultItem(s, index, emotion1, emotion2) {
            const itemDiv = document.createElement('div');
            const tagSpan = document.createElement('span');
            const pairDiv = document.createElement('div');
            const scoresDiv = document.createElement('div');
            const metricsDiv = document.createElement('div');
            const scoreSpan = document.createElement('span');
            const balanceSpan = document.createElement('span');
            const intensitySpan = document.createElement('span');

            let tagClass = '';
            let tagText = '';
            if (s.newspaper === 'LO' && s.contentType === 'Editorial') {
                tagClass = 'lo-editorial'; tagText = 'LO Editorial';
            } else if (s.newspaper === 'LO' && s.contentType === 'Submission') {
                tagClass = 'lo-correspondence'; tagText = 'LO Correspondence';
            } else if (s.newspaper === 'LWR' && s.contentType === 'Editorial') {
                tagClass = 'lwr-editorial'; tagText = 'LWR Editorial';
            } else if (s.newspaper === 'LWR' && s.contentType === 'Submission') {
                tagClass = 'lwr-correspondence'; tagText = 'LWR Correspondence';
            }

            let borderColor = '#667eea';
            if (tagClass === 'lo-editorial') borderColor = '#e74c3c';
            else if (tagClass === 'lo-correspondence') borderColor = '#f39c12';
            else if (tagClass === 'lwr-editorial') borderColor = '#3498db';
            else if (tagClass === 'lwr-correspondence') borderColor = '#27ae60';

            itemDiv.className = 'result-item';
            itemDiv.style.borderLeftColor = borderColor;

            tagSpan.className = `content-tag ${tagClass}`;
            tagSpan.textContent = tagText;

            pairDiv.className = 'emotion-pair';
            const date = s.year ?? s.Year ?? 'N/A';
            pairDiv.textContent = `#${index + 1}: Article ${String(s.id ?? '')} (${String(date)})`;

            const v1 = Number(s[emotion1] ?? 0);
            const v2 = Number(s[emotion2] ?? 0);
            scoresDiv.textContent = `${emotion1}: ${v1.toFixed(3)} | ${emotion2}: ${v2.toFixed(3)}`;

            scoreSpan.className = 'score';
            scoreSpan.textContent = `Score: ${Number(s.doubleVoice ?? 0).toFixed(3)}`;
            scoreSpan.setAttribute('data-tooltip', `Geometric mean:\n‚àö(${emotion1} √ó ${emotion2})`);

            balanceSpan.className = 'score';
            balanceSpan.style.background = '#27ae60';
            balanceSpan.textContent = `Balance: ${Number(s.balance ?? 0).toFixed(3)}`;
            balanceSpan.setAttribute('data-tooltip', `Balance measure:\n1 - |${emotion1} - ${emotion2}|`);

            intensitySpan.className = 'score';
            intensitySpan.style.background = '#3498db';
            intensitySpan.textContent = `Intensity: ${Number(s.intensity ?? 0).toFixed(3)}`;
            intensitySpan.setAttribute('data-tooltip', `Average intensity:\n(${emotion1} + ${emotion2}) / 2`);

            metricsDiv.append(scoreSpan, balanceSpan, intensitySpan);
            itemDiv.append(tagSpan, pairDiv, scoresDiv, metricsDiv);
            return itemDiv;
        }

        function toggleFormulas(button) {
            const section = document.getElementById('formulaSection');
            const isHidden = section.style.display === 'none';
            section.style.display = isHidden ? 'block' : 'none';
            if (button) {
                button.textContent = isHidden ? 'üìä Hide Formulas' : 'üìä Show Formulas';
            }
        }

        function compareEditorialReader() {
            selectNewspaper('FOUR_CATEGORY');
        }

        function toggleValidation() {
            const section = document.getElementById('validationInfo');
            const validationButton = document.getElementById('toggleValidationBtn');

            if (section.style.display === 'none') {
                section.style.display = 'block';
                validationButton.textContent = 'üî¨ Hide Validation';
            } else {
                section.style.display = 'none';
                validationButton.textContent = 'üî¨ Show Validation';
            }
        }

        function updateReliabilityWarning() {
            const pair = document.getElementById('emotionPair').value;
            const warningDiv = document.getElementById('reliabilityWarning');

            switch(pair) {
                case 'Trust_Disgust':
                    warningDiv.textContent = '‚úÖ High reliability (Œ∫=0.705, 0.843) - Both emotions well-detected';
                    warningDiv.style.color = '#27ae60';
                    break;
                case 'Joy_Sadness':
                    warningDiv.textContent = '‚ö†Ô∏è Asymmetric: Joy reliable (Œ∫=0.747), Sadness limited (Œ∫=0.321)';
                    warningDiv.style.color = '#f39c12';
                    break;
                case 'Anger_Fear':
                    warningDiv.textContent = '‚ö†Ô∏è Asymmetric: Anger reliable (Œ∫=0.819), Fear limited (Œ∫=0.300)';
                    warningDiv.style.color = '#f39c12';
                    break;
                case 'Anticipation_Surprise':
                    warningDiv.textContent = '‚ö†Ô∏è Moderate reliability (Œ∫=0.419, 0.441) - Use supplementary';
                    warningDiv.style.color = '#e67e22';
                    break;
            }
        }

        function updateComparisonCharts() {
            const pair = document.getElementById('emotionPair').value;
            const threshold = parseFloat(document.getElementById('threshold').value);
            const [emotion1, emotion2] = pair.split('_');

            // Get all 4 categories
            const loEditorials = loEditorialData;
            const loCorrespondence = loSubmissionsData;
            const lwrEditorials = lwrEditorialData;
            const lwrCorrespondence = lwrSubmissionsData;

            // Calculate stats for each category
            const loeStats = calculateContentStats(loEditorials, emotion1, emotion2, threshold);
            const locStats = calculateContentStats(loCorrespondence, emotion1, emotion2, threshold);
            const lwreStats = calculateContentStats(lwrEditorials, emotion1, emotion2, threshold);
            const lwrcStats = calculateContentStats(lwrCorrespondence, emotion1, emotion2, threshold);

            // Update comparison charts
            updateComparisonBarChart(loeStats, locStats, lwreStats, lwrcStats, emotion1, emotion2);
            updateDistributionChart(loEditorials, loCorrespondence, lwrEditorials, lwrCorrespondence, emotion1, emotion2);
        }

        function calculateContentStats(data, emotion1, emotion2, threshold) {
            const validDV = data.filter(d =>
                d[emotion1] >= threshold && d[emotion2] >= threshold
            );

            return {
                total: data.length,
                validDV: validDV.length,
                percentage: data.length > 0 ? (validDV.length / data.length * 100).toFixed(1) : 0,
                avgEmotion1: data.length > 0 ?
                    data.reduce((sum, d) => sum + (d[emotion1] || 0), 0) / data.length : 0,
                avgEmotion2: data.length > 0 ?
                    data.reduce((sum, d) => sum + (d[emotion2] || 0), 0) / data.length : 0,
                avgDVScore: validDV.length > 0 ?
                    validDV.reduce((sum, d) => sum + Math.sqrt(d[emotion1] * d[emotion2]), 0) / validDV.length : 0
            };
        }

        function updateComparisonBarChart(loeStats, locStats, lwreStats, lwrcStats, emotion1, emotion2) {
            const ctx = document.getElementById('comparisonChart').getContext('2d');

            const barData = {
                labels: ['Total Articles', 'Valid DV', 'DV %', `Avg ${emotion1}`, `Avg ${emotion2}`, 'Avg DV Score'],
                datasets: [{
                    label: 'LO Editorial',
                    data: [
                        loeStats.total,
                        loeStats.validDV,
                        parseFloat(loeStats.percentage),
                        loeStats.avgEmotion1,
                        loeStats.avgEmotion2,
                        loeStats.avgDVScore
                    ],
                    backgroundColor: 'rgba(231, 76, 60, 0.6)',
                    borderColor: 'rgba(231, 76, 60, 1)',
                    borderWidth: 2
                }, {
                    label: 'LO Correspondence',
                    data: [
                        locStats.total,
                        locStats.validDV,
                        parseFloat(locStats.percentage),
                        locStats.avgEmotion1,
                        locStats.avgEmotion2,
                        locStats.avgDVScore
                    ],
                    backgroundColor: 'rgba(243, 156, 18, 0.6)',
                    borderColor: 'rgba(243, 156, 18, 1)',
                    borderWidth: 2
                }, {
                    label: 'LWR Editorial',
                    data: [
                        lwreStats.total,
                        lwreStats.validDV,
                        parseFloat(lwreStats.percentage),
                        lwreStats.avgEmotion1,
                        lwreStats.avgEmotion2,
                        lwreStats.avgDVScore
                    ],
                    backgroundColor: 'rgba(52, 152, 219, 0.6)',
                    borderColor: 'rgba(52, 152, 219, 1)',
                    borderWidth: 2
                }, {
                    label: 'LWR Correspondence',
                    data: [
                        lwrcStats.total,
                        lwrcStats.validDV,
                        parseFloat(lwrcStats.percentage),
                        lwrcStats.avgEmotion1,
                        lwrcStats.avgEmotion2,
                        lwrcStats.avgDVScore
                    ],
                    backgroundColor: 'rgba(46, 204, 113, 0.6)',
                    borderColor: 'rgba(46, 204, 113, 1)',
                    borderWidth: 2
                }]
            };

            const barTitle = 'Four-Way Comparison: Editorial vs Correspondence by Newspaper';

            // Performance: Use chart.update() instead of destroy + recreate
            if (comparisonChart) {
                // Update existing chart
                comparisonChart.data = barData;
                comparisonChart.options.plugins.title.text = barTitle;
                comparisonChart.update();
            } else {
                // Create chart for the first time
                comparisonChart = new Chart(ctx, {
                    type: 'bar',
                    data: barData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: barTitle
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
        }

        function updateDistributionChart(loEditorials, loCorrespondence, lwrEditorials, lwrCorrespondence, emotion1, emotion2) {
            const ctx = document.getElementById('distributionChart').getContext('2d');

            // Calculate distribution for each category
            const loeDist = calculateDistribution(loEditorials, emotion1, emotion2);
            const locDist = calculateDistribution(loCorrespondence, emotion1, emotion2);
            const lwreDist = calculateDistribution(lwrEditorials, emotion1, emotion2);
            const lwrcDist = calculateDistribution(lwrCorrespondence, emotion1, emotion2);

            const radarData = {
                labels: [`Low ${emotion1}`, `High ${emotion1}`, `Low ${emotion2}`,
                        `High ${emotion2}`, 'Balanced DV', 'Intense DV'],
                datasets: [{
                    label: 'LO Editorial',
                    data: loeDist,
                    borderColor: 'rgba(231, 76, 60, 1)',
                    backgroundColor: 'rgba(231, 76, 60, 0.2)'
                }, {
                    label: 'LO Correspondence',
                    data: locDist,
                    borderColor: 'rgba(243, 156, 18, 1)',
                    backgroundColor: 'rgba(243, 156, 18, 0.2)'
                }, {
                    label: 'LWR Editorial',
                    data: lwreDist,
                    borderColor: 'rgba(52, 152, 219, 1)',
                    backgroundColor: 'rgba(52, 152, 219, 0.2)'
                }, {
                    label: 'LWR Correspondence',
                    data: lwrcDist,
                    borderColor: 'rgba(46, 204, 113, 1)',
                    backgroundColor: 'rgba(46, 204, 113, 0.2)'
                }]
            };

            const radarTitle = 'Emotional Pattern Distribution - All Categories';

            // Performance: Use chart.update() instead of destroy + recreate
            if (distributionChart) {
                // Update existing chart
                distributionChart.data = radarData;
                distributionChart.options.plugins.title.text = radarTitle;
                distributionChart.update();
            } else {
                // Create chart for the first time
                distributionChart = new Chart(ctx, {
                    type: 'radar',
                    data: radarData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: radarTitle
                            }
                        },
                        scales: {
                            r: {
                                beginAtZero: true,
                                max: 1
                            }
                        }
                    }
                });
            }
        }

        function calculateDistribution(data, emotion1, emotion2) {
            if (data.length === 0) return [0, 0, 0, 0, 0, 0];

            const lowEmotion1 = data.filter(d => (d[emotion1] || 0) < 0.3).length / data.length;
            const highEmotion1 = data.filter(d => (d[emotion1] || 0) > 0.7).length / data.length;
            const lowEmotion2 = data.filter(d => (d[emotion2] || 0) < 0.3).length / data.length;
            const highEmotion2 = data.filter(d => (d[emotion2] || 0) > 0.7).length / data.length;
            const balanced = data.filter(d =>
                Math.abs((d[emotion1] || 0) - (d[emotion2] || 0)) < 0.2).length / data.length;
            const intense = data.filter(d =>
                (d[emotion1] || 0) > 0.5 && (d[emotion2] || 0) > 0.5).length / data.length;

            return [lowEmotion1, highEmotion1, lowEmotion2, highEmotion2, balanced, intense];
        }

        function updateTemporalCharts() {
            // Implementation for temporal analysis charts
        }

        function exportResults() {
            try {
                if (allData.length === 0) {
                    alert('No data to export. Please upload data files first.');
                    return;
                }

                const pair = document.getElementById('emotionPair').value;
                const threshold = parseFloat(document.getElementById('threshold').value);
                const [emotion1, emotion2] = pair.split('_');

                const exportData = allData.map(record => {
                    const dvScores = calculateDoubleVoice(record, emotion1, emotion2, threshold);

                    // Create category label
                    let category = '';
                    if (record.newspaper === 'LO' && record.contentType === 'Editorial') {
                        category = 'LO_Editorial';
                    } else if (record.newspaper === 'LO' && record.contentType === 'Submission') {
                        category = 'LO_Correspondence';
                    } else if (record.newspaper === 'LWR' && record.contentType === 'Editorial') {
                        category = 'LWR_Editorial';
                    } else if (record.newspaper === 'LWR' && record.contentType === 'Submission') {
                        category = 'LWR_Correspondence';
                    }

                    return {
                        Category: sanitizeForCSV(category),
                        Newspaper: sanitizeForCSV(record.newspaper),
                        ContentType: sanitizeForCSV(record.contentType === 'Submission' ? 'Correspondence' : (record.contentType || '')),
                        ID: sanitizeForCSV(record.id),
                        Year: record.year || record.Year || '',
                        [emotion1]: Number(record[emotion1] ?? 0),
                        [emotion2]: Number(record[emotion2] ?? 0),
                        DoubleVoice_Score: Number(dvScores.geometric ?? 0).toFixed(5),
                        Balance: Number(dvScores.balance ?? 0).toFixed(5),
                        Intensity: Number(dvScores.intensity ?? 0).toFixed(5),
                        IsValidDV: dvScores.isValid ? 1 : 0,
                        Threshold: threshold
                    };
                });

                // Convert to CSV using Papa Parse with BOM for Excel compatibility
                const csv = '\ufeff' + Papa.unparse(exportData, {
                    quotes: true,
                    delimiter: ",",
                    header: true
                });

                // Create blob and download
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;

                // Create filename with local timestamp
                const timestamp = localDateStamp();
                const filename = `double_voice_analysis_${emotion1}_${emotion2}_${timestamp}.csv`;
                link.download = filename;

                // Trigger download
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                // Clean up
                window.URL.revokeObjectURL(url);

            } catch (error) {
                console.error('Export error:', error);
                alert('Error exporting data: ' + error.message);
            }
        }

        // DOMContentLoaded event listener to initialize all event handlers
        document.addEventListener('DOMContentLoaded', () => {
            // Threshold slider
            const slider = document.getElementById('threshold');
            const sliderVal = document.getElementById('thresholdValue');
            if (slider && sliderVal) {
                slider.addEventListener('input', (e) => {
                    sliderVal.textContent = e.target.value;
                });
                slider.addEventListener('change', updateAnalysis);
            }

            // Emotion pair change
            document.getElementById('emotionPair')?.addEventListener('change', () => {
                updateReliabilityWarning();
                updateAnalysis();
            });

            // File uploads
            document.getElementById('loFileInput')?.addEventListener('change', (e) => handleFileUpload(e, 'LO_Editorial'));
            document.getElementById('loSubmissionsFileInput')?.addEventListener('change', (e) => handleFileUpload(e, 'LO_Submission'));
            document.getElementById('lwrFileInput')?.addEventListener('change', (e) => handleFileUpload(e, 'LWR_Editorial'));

            // Newspaper cards
            document.getElementById('lo-card')?.addEventListener('click', () => selectNewspaper('LO'));
            document.getElementById('lwr-card')?.addEventListener('click', () => selectNewspaper('LWR'));
            document.getElementById('editorial-reader-card')?.addEventListener('click', () => selectNewspaper('FOUR_CATEGORY'));

            // Tabs
            document.querySelector('[data-tab="overview"]')?.addEventListener('click', (e) => switchTab(e, 'overview'));
            document.querySelector('[data-tab="comparison"]')?.addEventListener('click', (e) => switchTab(e, 'comparison'));

            // Buttons
            document.getElementById('updateAnalysisBtn')?.addEventListener('click', updateAnalysis);
            document.getElementById('exportBtn')?.addEventListener('click', exportResults);
            document.getElementById('compareBtn')?.addEventListener('click', compareEditorialReader);
            document.getElementById('toggleFormulasBtn')?.addEventListener('click', (e) => toggleFormulas(e.currentTarget));
            document.getElementById('toggleValidationBtn')?.addEventListener('click', toggleValidation);

            // Filter changes
            document.getElementById('contentTypeFilter')?.addEventListener('change', updateAnalysis);
            document.getElementById('newspaperFilter')?.addEventListener('change', updateAnalysis);
            document.getElementById('yearFrom')?.addEventListener('change', updateAnalysis);
            document.getElementById('yearTo')?.addEventListener('change', updateAnalysis);

            // Initial updates
            updateReliabilityWarning();
            updateAnalysis();
        });
    </script>
</body>
</html>
